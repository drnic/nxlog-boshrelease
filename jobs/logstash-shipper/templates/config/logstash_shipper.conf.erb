########################################
# Global directives                    #
########################################
CacheDir /var/vcap/store/logstash-shipper
PidFile /var/vcap/sys/run/logstash-shipper/logstash-shipper.pid
LogFile /var/vcap/sys/log/logstash-shipper/logstash-shipper.log
LogLevel INFO

########################################
# Modules                              #
########################################

<Extension syslog>
    Module        xm_syslog
</Extension>

########################################
# Routes                               #
########################################
<Input in_files>
    Module        im_file
    File          "/var/vcap/data/sys/log/*.log"
    Recursive     true
    SavePos       true
    InputType     LineBased
    PollInterval  <%= p("nxlog.pollinterval") %>

    Exec          if (file_name() =~ /(monit|logstash\-shipper)/) drop();
    Exec          $bosh_deployment = "<%= spec.deployment %>";
    Exec          $bosh_job_name = "<%= name %>";
    Exec          $bosh_job_index = "<%= index %>";
    Exec          $filename = file_name();
    Exec          $EventReceivedTime = undef;
    Exec          $SourceModuleName = undef;
    Exec          $SourceModuleType = undef;
</Input>

<% logstashServer = p('logstash.server').split(':') %>
<Output out_logstash>
    Module        om_tcp
    Host          <%= logstashServer[0] %>
    Port          <%= logstashServer[1] %>
    Exec          to_syslog_ietf();
    OutputType    LineBased
</Output>

<Route 2logstash>
    Path          in_files => out_logstash
</Route>
